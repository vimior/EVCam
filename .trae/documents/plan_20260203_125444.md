# 解决悬浮窗黑屏卡死及优化转向灯补盲逻辑 (修订版)

## 1. 解决悬浮窗黑屏/画面卡死问题 (资源复用与冲突解决)
### 核心原因分析
- **Session 重建冲突**：当主/副屏并发触发 [SingleCamera.java](file:///c:/Users/Kyle/Desktop/evcam/EVCamKyle/app/src/main/java/com/kooo/evcam/camera/SingleCamera.java) 的 `recreateSession()` 时，异步配置过程中的资源竞争导致 Session 配置失败或黑屏。
- **重复打开摄像头**：确认 [MultiCameraManager.java](file:///c:/Users/Kyle/Desktop/evcam/EVCamKyle/app/src/main/java/com/kooo/evcam/camera/MultiCameraManager.java) 已经正确处理了 `PRIMARY/SECONDARY` 实例，但需要确保所有组件都通过该管理器获取实例，严禁自行创建 `SingleCamera`。

### 解决方案
- **增强 SingleCamera 的配置稳定性**：
    - 在 [SingleCamera.java](file:///c:/Users/Kyle/Desktop/evcam/EVCamKyle/app/src/main/java/com/kooo/evcam/camera/SingleCamera.java) 中引入 `isConfiguring` 标志位，确保 `createCaptureSession` 在前一个配置任务完成前不会被重复触发。
    - 优化 `recreateSession` 的防抖机制，合并极短时间内的多次请求。
- **避免冗余 Session 重建**：
    - 在 [MainFloatingWindowView.java](file:///c:/Users/Kyle/Desktop/evcam/EVCamKyle/app/src/main/java/com/kooo/evcam/MainFloatingWindowView.java) 和 [BlindSpotService.java](file:///c:/Users/Kyle/Desktop/evcam/EVCamKyle/app/src/main/java/com/kooo/evcam/BlindSpotService.java) 中增加检查：如果目标摄像头已在当前 Surface 显示且有效，则不调用 `recreateSession`。

## 2. 优化转向灯联动逻辑
- 修改 [BlindSpotService.java](file:///c:/Users/Kyle/Desktop/evcam/EVCamKyle/app/src/main/java/com/kooo/evcam/BlindSpotService.java)：
    - 在接收到转向灯信号时，先对比 `currentSignalCamera`。只有当信号发生变化（如左转切换到右转，或从无信号变为有信号）时才执行切换动作。

## 3. 实现转向灯补盲独立工作逻辑 (全场景适配)
### 逻辑要求实现方案
我们将 [BlindSpotService.java](file:///c:/Users/Kyle/Desktop/evcam/EVCamKyle/app/src/main/java/com/kooo/evcam/BlindSpotService.java) 的逻辑重构为“状态感知型”：
- **状态追踪**：对主屏和副屏分别维护 `isMainTempShown` 和 `isSecondaryTempShown` 标志。
- **触发逻辑**：
    - **主屏**：如果 `appConfig.isMainFloatingEnabled()` 为 `false`，则弹出临时悬浮窗并标记 `isMainTempShown = true`；如果已开启，则直接切换摄像头。
    - **副屏**：如果 `appConfig.isSecondaryDisplayEnabled()` 为 `false`，则弹出临时副屏窗并标记 `isSecondaryTempShown = true`；如果已开启，则直接切换摄像头。
    - **配置复用**：所有临时弹出的悬浮窗，其位置（X, Y）和大小（Width, Height）均严格复用 [AppConfig.java](file:///c:/Users/Kyle/Desktop/evcam/EVCamKyle/app/src/main/java/com/kooo/evcam/AppConfig.java) 中的用户配置。
- **恢复逻辑 (超时后)**：
    - 如果是临时弹出的 (`isTempShown == true`)：执行 `dismiss()` / `removeView()` 彻底关闭。
    - 如果是用户开启的 (`isTempShown == false`)：执行 `updateCamera()` 切回用户原本设定的默认摄像头。

### 场景示例：
- **主关副开**：右转信号 -> 主屏弹出临时窗（显示右摄），副屏切换到右摄。超时 -> 主屏临时窗关闭，副屏切回原画面。

## 验证计划
- **功能测试**：
    1. **资源抢占**：主副屏同选一摄像头，观察是否能秒开且无卡死。
    2. **转向补盲**：测试“主关副开”、“主开副关”、“全关”、“全开”四种组合下的转向灯触发与超时恢复。
    3. **配置复用**：调整悬浮窗位置大小后，关闭悬浮窗，打转向灯验证弹出的临时窗位置是否一致。

请确认此修订版方案。确认后我将开始实施。